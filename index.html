<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 댓글 수집기</title>
</head>
<body>
    <h1>YouTube 댓글 수집기</h1>
    <p>유튜브 동영상 URL을 입력하세요:</p>
    <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=video_id" style="width: 300px;">
    <button onclick="fetchComments()">댓글 가져오기</button>
    <button id="downloadBtn" style="display: none;" onclick="downloadCSV()">CSV 다운로드</button>
    <div id="output"></div>
    <script>
        // YouTube Data API Key
        const API_KEY = 'AIzaSyBCQan9kdiShVn4749njULXUAtiLnbA7Ts'; // 발급받은 API 키 입력
        let comments = []; // 수집한 댓글 데이터를 저장

        function extractVideoId(url) {
            const match = url.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        }

        async function fetchComments() {
            const videoUrl = document.getElementById('videoUrl').value;
            const videoId = extractVideoId(videoUrl);

            if (!videoId) {
                document.getElementById('output').innerText = "유효한 유튜브 URL을 입력하세요!";
                return;
            }

            let nextPageToken = '';
            comments = []; // 이전 데이터 초기화
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = `<p>댓글을 수집 중입니다... 잠시만 기다려주세요.</p>`;

            try {
                do {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&key=${API_KEY}&pageToken=${nextPageToken}&maxResults=100`);
                    const data = await response.json();

                    if (data.error) {
                        outputDiv.innerHTML = `<p>API 요청 중 오류가 발생했습니다: ${data.error.message}</p>`;
                        return;
                    }

                    data.items.forEach(item => {
                        const comment = item.snippet.topLevelComment.snippet;
                        comments.push({
                            author: comment.authorDisplayName,
                            text: comment.textDisplay,
                            likes: comment.likeCount,
                            publishedAt: comment.publishedAt
                        });
                    });

                    nextPageToken = data.nextPageToken || '';
                } while (nextPageToken);

                displayComments(comments);
                document.getElementById('downloadBtn').style.display = 'inline-block'; // CSV 다운로드 버튼 표시
            } catch (error) {
                outputDiv.innerHTML = `<p>댓글 수집 중 오류가 발생했습니다: ${error.message}</p>`;
            }
        }

        function displayComments(comments) {
            const outputDiv = document.getElementById('output');
            let html = `<h2>수집된 댓글 (${comments.length}개)</h2><ul>`;
            comments.forEach(comment => {
                html += `
                    <li>
                        <p><strong>${comment.author}</strong> (${comment.publishedAt}):</p>
                        <p>${comment.text}</p>
                        <p>좋아요: ${comment.likes}</p>
                    </li>
                `;
            });
            html += `</ul>`;
            outputDiv.innerHTML = html;
        }

        function downloadCSV() {
            if (comments.length === 0) {
                alert("다운로드할 댓글 데이터가 없습니다.");
                return;
            }

            // CSV 형식으로 변환
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Author,Text,Likes,PublishedAt\n";
            comments.forEach(comment => {
                const row = `"${comment.author}","${comment.text.replace(/"/g, '""')}","${comment.likes}","${comment.publishedAt}"`;
                csvContent += row + "\n";
            });

            // CSV 파일 생성 및 다운로드
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "youtube_comments.csv");
            document.body.appendChild(link); // 필요할 경우 링크 추가
            link.click();
            document.body.removeChild(link); // 다운로드 후 링크 제거
        }
    </script>
</body>
</html>